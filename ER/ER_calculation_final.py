import pm4py
import pandas as pd
import numpy as np
import os
import json
import math
import networkx as nx
import argparse
from tqdm import tqdm

def extract_time_period_sublog(df, case_id_col, activity_col, timestamp_col, start_time, end_time):
    """
    Extract a sublog containing only the directly-follows relations where the end activities
    fall within the specified time period.

    Parameters:
    - df: The event log dataframe
    - case_id_col: Column name for case IDs
    - activity_col: Column name for activities
    - timestamp_col: Column name for timestamps
    - start_time: Start of the time period
    - end_time: End of the time period

    Returns:
    - A dataframe containing the relevant events
    """
    # Sort the dataframe by case ID and timestamp
    df = df.sort_values(by=[case_id_col, timestamp_col])

    # Step 1: Identify cases that have at least one event within the time period
    cases_in_period = df[(df[timestamp_col] >= start_time) &
                         (df[timestamp_col] <= end_time)][case_id_col].unique()

    # Step 2: Filter to only those cases
    case_df = df[df[case_id_col].isin(cases_in_period)].copy()

    # Step 3: For each case, find all events that are needed to maintain directly-follows relations
    # where the end activity is within the time period
    result_events = []

    for case_id in cases_in_period:
        case_events = case_df[case_df[case_id_col] == case_id].copy()
        case_events['next_timestamp'] = case_events[timestamp_col].shift(-1)
        case_events['is_within_period'] = (case_events[timestamp_col] >= start_time) & (
                    case_events[timestamp_col] <= end_time)
        case_events['next_within_period'] = (case_events['next_timestamp'] >= start_time) & (
                    case_events['next_timestamp'] <= end_time)

        # Include events that are either:
        # 1. Within the time period themselves
        # 2. Directly followed by an event within the time period
        relevant_events = case_events[case_events['is_within_period'] | case_events['next_within_period']]
        result_events.append(relevant_events)

    if not result_events:
        return pd.DataFrame(columns=df.columns)

    # Combine all relevant events
    result_df = pd.concat(result_events)

    # replace symbols by texts
    result_df[activity_col] = result_df[activity_col].replace({'▶': 'Start', '■': 'End'})

    # Return the original columns only
    return result_df[df.columns].sort_values(by=[case_id_col, timestamp_col])


def extract_rolling_window_sublogs(df, case_id_col, activity_col, timestamp_col, start_time, time_length_days):
    """
    Extract a series of sublogs using a rolling window of specified time length.

    Parameters:
    - df: The event log dataframe
    - case_id_col: Column name for case IDs
    - activity_col: Column name for activities
    - timestamp_col: Column name for timestamps
    - start_time: Start of the time period (string or datetime)
    - time_length_days: Length of each time window in days (integer or string)

    Returns:
    - A dictionary of dataframes, each containing a sublog for a specific time window
    """
    # Convert timestamps to datetime if they aren't already
    df = df.copy()
    if not pd.api.types.is_datetime64_any_dtype(df[timestamp_col]):
        df[timestamp_col] = pd.to_datetime(df[timestamp_col])

    # Convert time_length_days to int if it's a string
    time_length_days = int(time_length_days)

    # Convert start_time to datetime if it's not already
    if not isinstance(start_time, pd.Timestamp):
        start_time = pd.to_datetime(start_time)

    # Check if df timestamps have timezone and start_time doesn't
    sample_timestamp = df[timestamp_col].iloc[0]
    if hasattr(sample_timestamp, 'tz') and sample_timestamp.tz is not None and start_time.tz is None:
        # Localize start_time to match the timestamps in the dataframe
        start_time = start_time.tz_localize(sample_timestamp.tz)

    # Get the overall end time from the data
    data_end_time = df[timestamp_col].max()

    # Calculate the number of rolling windows
    time_delta = data_end_time - start_time
    num_windows = max(1, time_delta.days - time_length_days + 2)  # +2 to include the first and last window

    # Create a dictionary to store all sublogs
    sublogs = {}

    # Create rolling windows and extract sublogs
    for i in range(num_windows):
        window_start = start_time + pd.Timedelta(days=i)
        window_end = window_start + pd.Timedelta(days=time_length_days - 1)

        # Format dates for the key
        window_key = f"{window_start.strftime('%Y-%m-%d')}_{window_end.strftime('%Y-%m-%d')}"

        # Extract sublog for this window
        sublog = extract_time_period_sublog(
            df,
            case_id_col,
            activity_col,
            timestamp_col,
            window_start,
            window_end
        )

        # Only add the sublog if it contains events
        if len(sublog) > 0:
            # Ensure the timestamp column is recognized as datetime
            sublog[timestamp_col] = pd.to_datetime(sublog[timestamp_col])

            # Add artificial start/end events
            try:
                sublog_with_artificial = pm4py.insert_artificial_start_end(sublog)
                sublogs[window_key] = sublog_with_artificial
            except Exception as e:
                print(f"Warning: Could not add artificial start/end events for window {window_key}: {str(e)}")
                # Fall back to using the original sublog
                sublogs[window_key] = sublog

    return sublogs


# Configuration settings
DATASETS = {
    'BPI2017': {'start_time': '2016-10-22 00:00:00'},
    'sepsis': {'start_time': '2015-01-05 00:00:00'},
    'Hospital_Billing': {'start_time': '2015-02-05 00:00:00'},
    'BPI2019_1': {'start_time': '2018-11-19 00:00:00'}
}

MODELS = [
    'persistence', 
    'naive_seasonal', 
    'ar2', 
    'random_forest', 
    'xgboost', 
    'rnn', 
    'deepar'
]

HORIZONS = ['7', '28']

# Functions continue below...

def create_dfg_from_truth(dfg_truth):
    """
    Create DFG structure from PM4Py's DFG output

    Args:
        dfg_truth: Dictionary containing the DFG from PM4Py (format: {(source, target): frequency})

    Returns:
        DFG in JSON format
    """
    # Initialize node maps
    reverse_map = {}
    reverse_map['▶'] = 0
    reverse_map['■'] = 1

    # Map all activities to IDs
    for (source, target), freq in dfg_truth.items():
        if source not in reverse_map:
            reverse_map[source] = len(reverse_map)
        if target not in reverse_map:
            reverse_map[target] = len(reverse_map)

    # Create arcs
    arcs = []
    node_freq = {node: 0 for node in reverse_map.keys()}

    # Add directly-follows relations
    for (source, target), freq in dfg_truth.items():
        arcs.append({
            'from': reverse_map[source],
            'to': reverse_map[target],
            'freq': freq
        })
        if source == '▶':
            node_freq[source] += freq
        else:
            node_freq[target] += freq

    # Create nodes
    nodes = []
    for node, freq in node_freq.items():
        nodes.append({
            'label': node,
            'id': reverse_map[node],
            'freq': int(freq)
        })

    return {'nodes': nodes, 'arcs': arcs}

def create_dfgs_from_rolling_window(seq_test_log):
    """
    Create a series of DFGs from the rolling window sublogs.

    Parameters:
    - seq_test_log: Dictionary of sublogs from extract_rolling_window_sublogs

    Returns:
    - Dictionary with time window keys and corresponding DFG objects
    """

    # Create a dictionary to store all DFGs
    dfgs_dict = {}

    # For each sublog in the sequence, discover a DFG
    for window_key, sublog in seq_test_log.items():
        # Discover directly-follows graph
        dfg, _, _ = pm4py.discover_dfg(sublog)

        # Create JSON representation of the DFG
        dfg_json = create_dfg_from_truth(dfg)

        # Store in dictionary
        dfgs_dict[window_key] = {
            'dfg': dfg,
            'dfg_json': dfg_json,
            'sublog': sublog
        }

    return dfgs_dict

def create_dfg_from_predictions_new(predictions_df):
    """
    Create DFG structure from predictions dataframe with special start/end connections

    Args:
        predictions_df: DataFrame with predictions

    Returns:
        DFG in JSON format
    """
    # Extract directly-follows relations
    reverse_map = {}
    reverse_map['▶'] = 0  # Start symbol
    reverse_map['■'] = 1  # End symbol
    reverse_map['Start'] = 2  # Original Start (replacement for '▶' in input)
    reverse_map['End'] = 3  # Original End (replacement for '■' in input)

    # Track original activities (excluding start/end symbols)
    original_activities = set()

    # Process each column to extract activities
    for df_relation in predictions_df.columns:
        if '->' in df_relation:
            source, target = [part.strip() for part in df_relation.split('->')]

            # Replace symbols in source and target
            source = source.replace('▶', 'Start').replace('■', 'End')
            target = target.replace('▶', 'Start').replace('■', 'End')

            original_activities.add(source)
            original_activities.add(target)

            # Register activities
            if source not in reverse_map:
                reverse_map[source] = len(reverse_map)

            if target not in reverse_map:
                reverse_map[target] = len(reverse_map)

    # Create arcs with original frequencies between activities
    arcs = []
    node_freq = {node: 0 for node in reverse_map.keys()}

    # Process regular activity relationships
    for df_relation in predictions_df.columns:
        if '->' in df_relation:
            source, target = [part.strip() for part in df_relation.split('->')]
            clean_source = source.replace('▶', 'Start').replace('■', 'End')
            clean_target = target.replace('▶', 'Start').replace('■', 'End')

            # Map source and target IDs
            source_id = reverse_map.get(clean_source)
            target_id = reverse_map.get(clean_target)

            if source_id is not None and target_id is not None:
                # Sum frequency across all time steps
                total_freq = 0
                for _, row in predictions_df.iterrows():
                    freq = round(float(row[df_relation]))
                    if freq > 0:
                        total_freq += freq

                if total_freq > 0:
                    arcs.append({
                        'from': source_id,
                        'to': target_id,
                        'freq': total_freq
                    })
                    node_freq[clean_target] += total_freq

    # Add connections from '▶' to each activity with frequency 1
    for activity in original_activities:
        arcs.append({
            'from': reverse_map['▶'],
            'to': reverse_map[activity],
            'freq': 1
        })
        node_freq['▶'] += 1

    # Add connections from each activity to '■' with frequency 1
    for activity in original_activities:
        arcs.append({
            'from': reverse_map[activity],
            'to': reverse_map['■'],
            'freq': 1
        })
        node_freq['■'] += 1

    # Create nodes list
    nodes = []
    for node, node_id in reverse_map.items():
        nodes.append({
            'label': node,
            'id': node_id,
            'freq': round(node_freq.get(node, 0))
        })

    return {'nodes': nodes, 'arcs': arcs}

def create_dfgs_from_rolling_predictions(seq_test_log, agg_pred_round):
    """
    Create a series of DFGs from rolling window predictions.

    Parameters:
    - seq_test_log: Dictionary of sublogs from extract_rolling_window_sublogs (for window keys)
    - agg_pred_round: DataFrame with aggregated predictions

    Returns:
    - Dictionary with time window keys and corresponding predicted DFG objects
    """
    # Create a dictionary to store all DFGs
    dfgs_dict = {}

    # For each window in the sequence, create a DFG from predictions
    for window_key in seq_test_log.keys():
        # Get timestamp from window_key (format is 'YYYY-MM-DD_YYYY-MM-DD')
        start_date = window_key.split('_')[0]

        # Find corresponding predictions for this window
        window_pred = agg_pred_round.loc[agg_pred_round.index == start_date]

        if not window_pred.empty:
            # Create JSON representation of the DFG from predictions
            dfg_json = create_dfg_from_predictions_new(window_pred)

            # Store in dictionary
            dfgs_dict[window_key] = {
                'dfg_json': dfg_json,
                'window_pred': window_pred
            }

    return dfgs_dict

def reformat_rolling_dfgs(rolling_truth_dfgs, rolling_pred_dfgs):
    """
    Reformat rolling DFGs to have both truth and prediction data for each time window.

    Parameters:
    - rolling_truth_dfgs: Dictionary with time window keys and corresponding ground truth DFGs
    - rolling_pred_dfgs: Dictionary with time window keys and corresponding predicted DFGs

    Returns:
    - Dictionary where each key is a time window and each value has 'truth' and 'pred' components
    """
    combined_dfgs = {}

    # Find all time windows that exist in either dictionary
    all_windows = set(rolling_truth_dfgs.keys()) | set(rolling_pred_dfgs.keys())

    for window_key in all_windows:
        # Initialize entry for this time window
        combined_dfgs[window_key] = {}

        # Add ground truth DFG if available
        if window_key in rolling_truth_dfgs:
            combined_dfgs[window_key]['truth'] = {
                'nodes': rolling_truth_dfgs[window_key]['dfg_json']['nodes'],
                'arcs': rolling_truth_dfgs[window_key]['dfg_json']['arcs']
            }
        else:
            combined_dfgs[window_key]['truth'] = {'nodes': [], 'arcs': []}

        # Add prediction DFG if available
        if window_key in rolling_pred_dfgs:
            combined_dfgs[window_key]['pred'] = {
                'nodes': rolling_pred_dfgs[window_key]['dfg_json']['nodes'],
                'arcs': rolling_pred_dfgs[window_key]['dfg_json']['arcs']
            }
        else:
            combined_dfgs[window_key]['pred'] = {'nodes': [], 'arcs': []}

    return combined_dfgs












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































import pm4py
import pandas as pd
import numpy as np
import os
import json
import math
import networkx as nx
import argparse
from tqdm import tqdm

def extract_time_period_sublog(df, case_id_col, activity_col, timestamp_col, start_time, end_time):
    """
    Extract a sublog containing only the directly-follows relations where the end activities
    fall within the specified time period.

    Parameters:
    - df: The event log dataframe
    - case_id_col: Column name for case IDs
    - activity_col: Column name for activities
    - timestamp_col: Column name for timestamps
    - start_time: Start of the time period
    - end_time: End of the time period

    Returns:
    - A dataframe containing the relevant events
    """
    # Sort the dataframe by case ID and timestamp
    df = df.sort_values(by=[case_id_col, timestamp_col])

    # Step 1: Identify cases that have at least one event within the time period
    cases_in_period = df[(df[timestamp_col] >= start_time) &
                         (df[timestamp_col] <= end_time)][case_id_col].unique()

    # Step 2: Filter to only those cases
    case_df = df[df[case_id_col].isin(cases_in_period)].copy()

    # Step 3: For each case, find all events that are needed to maintain directly-follows relations
    # where the end activity is within the time period
    result_events = []

    for case_id in cases_in_period:
        case_events = case_df[case_df[case_id_col] == case_id].copy()
        case_events['next_timestamp'] = case_events[timestamp_col].shift(-1)
        case_events['is_within_period'] = (case_events[timestamp_col] >= start_time) & (
                    case_events[timestamp_col] <= end_time)
        case_events['next_within_period'] = (case_events['next_timestamp'] >= start_time) & (
                    case_events['next_timestamp'] <= end_time)

        # Include events that are either:
        # 1. Within the time period themselves
        # 2. Directly followed by an event within the time period
        relevant_events = case_events[case_events['is_within_period'] | case_events['next_within_period']]
        result_events.append(relevant_events)

    if not result_events:
        return pd.DataFrame(columns=df.columns)

    # Combine all relevant events
    result_df = pd.concat(result_events)

    # replace symbols by texts
    result_df[activity_col] = result_df[activity_col].replace({'▶': 'Start', '■': 'End'})

    # Return the original columns only
    return result_df[df.columns].sort_values(by=[case_id_col, timestamp_col])


def extract_rolling_window_sublogs(df, case_id_col, activity_col, timestamp_col, start_time, time_length_days):
    """
    Extract a series of sublogs using a rolling window of specified time length.

    Parameters:
    - df: The event log dataframe
    - case_id_col: Column name for case IDs
    - activity_col: Column name for activities
    - timestamp_col: Column name for timestamps
    - start_time: Start of the time period (string or datetime)
    - time_length_days: Length of each time window in days (integer or string)

    Returns:
    - A dictionary of dataframes, each containing a sublog for a specific time window
    """
    # Convert timestamps to datetime if they aren't already
    df = df.copy()
    if not pd.api.types.is_datetime64_any_dtype(df[timestamp_col]):
        df[timestamp_col] = pd.to_datetime(df[timestamp_col])

    # Convert time_length_days to int if it's a string
    time_length_days = int(time_length_days)

    # Convert start_time to datetime if it's not already
    if not isinstance(start_time, pd.Timestamp):
        start_time = pd.to_datetime(start_time)

    # Check if df timestamps have timezone and start_time doesn't
    sample_timestamp = df[timestamp_col].iloc[0]
    if hasattr(sample_timestamp, 'tz') and sample_timestamp.tz is not None and start_time.tz is None:
        # Localize start_time to match the timestamps in the dataframe
        start_time = start_time.tz_localize(sample_timestamp.tz)

    # Get the overall end time from the data
    data_end_time = df[timestamp_col].max()

    # Calculate the number of rolling windows
    time_delta = data_end_time - start_time
    num_windows = max(1, time_delta.days - time_length_days + 2)  # +2 to include the first and last window

    # Create a dictionary to store all sublogs
    sublogs = {}

    # Create rolling windows and extract sublogs
    for i in range(num_windows):
        window_start = start_time + pd.Timedelta(days=i)
        window_end = window_start + pd.Timedelta(days=time_length_days - 1)

        # Format dates for the key
        window_key = f"{window_start.strftime('%Y-%m-%d')}_{window_end.strftime('%Y-%m-%d')}"

        # Extract sublog for this window
        sublog = extract_time_period_sublog(
            df,
            case_id_col,
            activity_col,
            timestamp_col,
            window_start,
            window_end
        )

        # Only add the sublog if it contains events
        if len(sublog) > 0:
            # Ensure the timestamp column is recognized as datetime
            sublog[timestamp_col] = pd.to_datetime(sublog[timestamp_col])

            # Add artificial start/end events
            try:
                sublog_with_artificial = pm4py.insert_artificial_start_end(sublog)
                sublogs[window_key] = sublog_with_artificial
            except Exception as e:
                print(f"Warning: Could not add artificial start/end events for window {window_key}: {str(e)}")
                # Fall back to using the original sublog
                sublogs[window_key] = sublog

    return sublogs


# Configuration settings
DATASETS = {
    'BPI2017': {'start_time': '2016-10-22 00:00:00'},
    'sepsis': {'start_time': '2015-01-05 00:00:00'},
    'Hospital_Billing': {'start_time': '2015-02-05 00:00:00'},
    'BPI2019_1': {'start_time': '2018-11-19 00:00:00'}
}

MODELS = [
    'persistence', 
    'naive_seasonal', 
    'ar2', 
    'random_forest', 
    'xgboost', 
    'rnn', 
    'deepar'
]

HORIZONS = ['7', '28']

# Functions continue below...











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































